

# 实验九：入侵检测



## 环境配置



### 拓扑结构

![拓扑结构](img/拓扑结构.jpg)

- Kali-Attacker

  172.16.111.111

  

- Victim-Kali-1

  172.16.111.136



### snort安装



```bash
# 禁止在apt安装时弹出交互式配置界面
export DEBIAN_FRONTEND=noninteractive

apt install snort
```

### ![安装snort](img/安装snort.jpg)



## 实验过程

### 实验一：配置snort为嗅探模式

```bash
# 显示IP/TCP/UDP/ICMP头
snort -v

# 显示应用层数据
snort -vd

# 显示数据链路层报文头
snort -vde

# -b 参数表示报文存储格式为 tcpdump 格式文件
# -q 静默操作，不显示版本欢迎信息和初始化信息
snort -q -v -b -i eth0 "port not 22"

```



![显示头](img/显示头.jpg)



![显示应用层数据](img/显示应用层数据.jpg)

![显示数据链路层报文头](img/显示数据链路层报文头.jpg)

![抓包](img/抓包.jpg)



```bash
# 使用 CTRL-C 退出嗅探模式
# 嗅探到的数据包会保存在 /var/log/snort/snort.log.<epoch timestamp>
# 其中<epoch timestamp>为抓包开始时间的UNIX Epoch Time格式串
# 可以通过命令 date -d @<epoch timestamp> 转换时间为人类可读格式
# exampel: date -d @1511870195 转换时间为人类可读格式
# 上述命令用tshark等价实现如下：
tshark -i eth0 -f "port not 22" -w 1_tshark.pcap
```

![1_tshark](img\1_tshark.jpg)



### 实验二：配置并启用snort内置规则

```bash
# /etc/snort/snort.conf 中的 HOME_NET 和 EXTERNAL_NET 需要正确定义
# 例如，学习实验目的，可以将上述两个变量值均设置为 any
snort -q -A console -b -i eth0 -c /etc/snort/snort.conf -l /var/log/snort/
```



![配置启用内部规则](img/配置启用内部规则.jpg)



### 实验三：自定义snort规则

```bash
# 新建自定义 snort 规则文件
cat << EOF > /etc/snort/rules/cnss.rules
alert tcp \$EXTERNAL_NET any -> \$HTTP_SERVERS 80 (msg:"Access Violation has been detected on /etc/passwd ";flags: A+; content:"/etc/passwd"; nocase;sid:1000001; rev:1;)
alert tcp \$EXTERNAL_NET any -> \$HTTP_SERVERS 80 (msg:"Possible too many connections toward my http server"; threshold:type threshold, track by_src, count 100, seconds 2; classtype:attempted-dos; sid:1000002; rev:1;)
EOF
```

![自定义snort规则](img/自定义snort规则.jpg)



```bash
# 添加配置代码到 /etc/snort/snort.conf
include $RULE_PATH/cnss.rules

snort -q -A fast -b -i eth0 -c /etc/snort/snort.conf -l /var/log/snort/
```

![添加配置代码](img/添加配置代码.jpg)



### 实验四：和防火墙联动

本实验需要用到的脚本代码 [Guardian-1.7.tar.gz](https://c4pr1c3.github.io/cuc-ns/chap0x09/attach/guardian.tar.gz) ，请下载后解压缩：

```bash
# 解压缩 Guardian-1.7.tar.gz
tar zxf guardian.tar.gz

# 安装 Guardian 的依赖 lib
apt install libperl4-corelibs-perl
```



在Victim上先后开启 `snort` 和 `guardian.pl`

```bash
# 开启 snort
snort -q -A fast -b -i eth1 -c /etc/snort/snort.conf -l /var/log/snort/
# 假设 guardian.tar.gz 解压缩后文件均在 /root/guardian 下
cd /root/guardian
```



编辑 guardian.conf 并保存，确认以下2个参数的配置符合主机的实际环境参数。

```ini
HostIpAddr      172.16.111.136
Interface       eth0
```

![改guardian.conf](img/改guardian.conf.jpg)



```bash
# 启动 guardian.pl
perl guardian.pl -c guardian.conf
```



![运行guardian并开启snort](img/运行guardian并开启snort.jpg)



在attack上用 `nmap` 暴力扫描 victim：

```bash
nmap 172.16.111.136 -A -T4 -n -vv
```

![暴力扫描](img/暴力扫描.jpg)

guardian.conf 中默认的来源IP被屏蔽时间是 60 秒（屏蔽期间如果黑名单上的来源IP再次触发snort报警消息，则屏蔽时间会继续累加60秒）



## 实验问题

- 安装软件snort出现报错`Could not open lock file /var/lib/dpkg/lock` 

  ![安装snort报错](img/安装snort报错.jpg)

  之前也用apt-get命令安装某个资源但是没有安装完就关闭terminal了，再次打开时导致了另外一个进程正在占用apt-get install进程。由于在运行时，会占用软件源更新时的系统锁，此时就会发生报错。

  解决办法，依次运行下列4条命令：

  ```
  sudo rm -rf /var/lib/dpkg/lock
  sudo rm -rf /var/cache/apt/archives/lock
  sudo apt-get update
  sudo dpkg --configure -a
  ```

- 共享文件夹没有权限打开

  初次使用共享文件夹，点进挂载目录会出现权限问题，发现是因为挂载点的用户是root，组是vboxsf ，所以解决办法就是把自己的用户名加入到vboxsf组：

  ```
  sudo usermod -a -G vboxsf kali
  ```



## 实验思考题

IDS与防火墙的联动防御方式相比IPS方式防御存在哪些缺陷？是否存在相比较而言的优势？

IDS通过软、硬件，对网络、系统的运行状况进行监视，尽可能发现各种攻击企图、攻击行为或者攻击结果，以保证网络系统资源的机密性、完整性和可用性。

IPS是一部能够监视网络或网络设备的网络资料传输行为的计算机网络安全设备，能够即时的中断、调整或隔离一些不正常或是具有伤害性的网络资料传输行为。

也就是说，IDS偏向于检测，属于管理系统，会检测出不安全的网络行为，但是不阻断任何网络行为。IPS偏向于防御，属于控制系统，可以阻止危险行为。

举个形象的例子，防火墙可以比作一栋楼的门锁，IDS就是警告系统，可以在有人撬锁后嗅探到，IPS则会在嗅探到有人撬锁后把门冻结。

 



## 参考资料

- [Could not open lock file/var/lib/dpkg/lock的解决办法](https://blog.csdn.net/weixin_40992982/article/details/97771332)

- [共享文件夹权限问题](https://blog.csdn.net/wulw1990/article/details/90731388?utm_source=app&app_version=4.18.0&code=app_1562916241&uLinkId=usr1mkqgl919blen)

- [vm虚拟机Kali无法拖拽文件解决办法](https://blog.csdn.net/weixin_30721077/article/details/96827555?spm=1001.2101.3001.6650.9&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-9.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-9.no_search_link)

- [2020-ns-public-LyuLumos](https://github.com/CUCCS/2020-ns-public-LyuLumos/blob/ch0x09/ch0x09/README.md#%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84)

- [实验九说明](https://c4pr1c3.gitee.io/cuc-ns/chap0x09/exp.html)